= ZStack Cloud 项目架构总览
:imagesdir: ../images/

[quote]
====
本文第一版为张鑫发表在 CSDN 的文章 http://web.archive.org/web/20160307182827/https://www.csdn.net/article/2015-04-10/2824443[《直戳OpenStack痛处？IaaS开源新兵ZStack架构设计全解析》]，但因为文章编写时间久远，很多内容已经有很多的变化，因此本文在原文基础上又做了大量修订，并将随代码和产品的演进将不断演进，经典的第一版架构总览可以通过链接查看。
====

== ZStack 的架构特点

ZStack 从诞生之初没有急于实现各种炫目的功能，而是花了大部分精力做架构设计，希望从架构上解决四个问题：易用性，稳定性，高性能，以及扩展性。ZStack 的所有的架构设计，全部围绕这四个方面展开：

=== 易用性

==== 管理节点的部署

在易用性方面，ZStack 首先考虑的是软件的安装部署与升级，其次是在长期使用的过程中的营运和维护。对于安装和部署，ZStack 是一个 Java 项目，在编译的完成后，所有的文件都会被打包到一个 Java 的 WAR 文件中。部署 ZStack 实际就是部署一个标准的 Java WAR 文件到 Apache Tomcat 这样的 web container 中。

这种部署是 Java web 应用的标准部署方法，非常简单且广为熟知。即使没有 IaaS 经验的的用户，也可以很容易学会安装。同时 ZStack 对外部的依赖非常少，仅仅需要 MySQL 数据库以及 Ansible 系统配置管理软件，这些都是 Linux 各个发行版提供的软件，而且都被打包在了 ZStack ISO 之中，无需用户单独安装。一个单管理节点的 ZStack 部署如图所示：

.单机部署的简单架构
image::overview-arch.png[]

得益于 `CloudBus` 本身的可扩展性和 `MySQL` 本身的高可用功能，通过 `zsha2` 工具（详见 zsha2 的文档），可以将 ZStack 扩展为一个高可用的架构。

下图 <<ha_arch>> 体现了一个较为常用的简单高可用架构，可以看到在单机的基础上增加了 `zsha2` 组件，`zsha2` 会控制 keepalived，选举出 VIP，并对数据库配置主主复制。管理节点访问数据库时通过 VIP 访问，保证管理节点的可用性，管理节点间通过一致性哈希自动会将负载进行负载均衡，中间通讯则通过 `CloudBus` 来完成。

[#ha_arch]
.较为常用的简单高可用架构
image::overview-multi-arch.png[]

对于比较简单的常见，用户直接访问 VIP 即可达到高可用的效果，对于希望将 UI Server 以及管理节点 web 服务也做负载均衡的用户，可以在整个架构前面再增加一个负载均衡，达到更好地负载均衡效果，但一般来说 UI 服务和管理节点的 web 服务负载并不大，因此不需要这样处理。

==== Agent 节点的部署

由于 IaaS 软件管理数据中心中大量的硬件，很多情况下需要安装 agent 到硬件上，例如安装 agent 到作为 KVM 计算节点的 Linux 机器。为了让用户从手动安装配置硬件的枯燥工作中解脱出来，ZStack 跟 Ansible 无缝集成，当用户添加一个计算节点时，ZStack 调用 Ansible 自动安装 agent 并配置系统，整个过程对用户透明。用户无需阅读冗长的文档去了解 agent 需要什么依赖包，需要怎么配置，这些全部由 ZStack 负责。用户只需调用一个 API 即可。类似的设计应用在所有需要安装 agent 的服务，例如负责提供网络功能的虚拟机 (Virutal Router VM)。

.Agent 部署
image::image-2022-03-02-14-33-04-712.png[]

KVM agent 的 Ansible 脚本详见 `zstack-utility` 的代码与文档。

配置文件和 KVM agent 的 Python 包都包含在 Java WAR 文件中，在用户调用 API 添加一个计算节点时，ZStack 会自动找到对应的配置文件并调用 Ansible 去部署 agent，用户甚至都不知道这个过程的存在。此外，对于高级用户，可以通过扩展 Ansible 配置文件来实现运维过程中的系统维护和升级。例如为了升级 KVM 机器的某个安装包修复一个安全漏洞，用户只需要在 KVM 的配置文件中加上相关内容，再调用 ZStack 的 ReconnectHost API，就可以自动实现升级功能。

====  丰富的监控

在监控方面，ZStack 目前提供对关键的系统资源比如物理机，虚拟机的状态进行监控，任何在 ZStack 控制外的状态变化，例如虚拟机的意外宕机，都会在一定的时间内被检测到并同步到数据库。此外 ZStack 还通过 Java 的 JMX 协议对外暴露监控自身的接口，例如监控当前系统运行的任务，系统正在处理的消息，消息的平均处理时间和最大处理时间等。让用户可以实时了解系统动态（参考 http://confluence.zstack.io/display/~shengyan.zhao/JMX+API+STATISTIC+TOOL ）。

==== 丰富的查询

丰富的查询 API 是 ZStack 为用户运维提供的一个重要功能。ZStack 的查询 API 提供超过 400 万单项查询条件，400 万阶乘的组合查询条件。用户在 API 层面就可以完成数据库级别的资源查询。查询 API 带来的意义是可以打造真正企业级的 UI。在优秀的企业软件中，例如微软 outlook，JIRA 中，用户都可以根据自己的需求创建不同的视图。在 IaaS 中也有同样的需求。用户可能需要视图显示所有在同一三级网络中的虚拟机，显示所有内存容量低于 2G 的物理服务器等。在没有完善的查询 API 支持下，UI 就只能提供几个默认视图，而无法允许用户自定义视图。

.强大的查询组合
image::image-2022-03-02-14-54-30-756.png[]

ZStack 的查询 API 的一个独特之处在于，查询框架在接收到 API 后可以自动生成 SQL 语句，无需编写代码。开发人员只要在数据库中定义了表，然后在 Java 程序中用 annotation 描述新表与其它表之间的 foreign key，再为新表继承一个查询 API 的基础类，所有工作就完成了。用户使用新 API 时，查询框架可以自动感知，根据用户的查询条件生成单表 SQL 以及多表 Join 的 SQL 语句。

=== 稳定性

==== 工作流引擎

IaaS 软件本身是个集成项目，管理了数据中心中大量的子系统，它实际上管理着所有子系统和所有设备的状态。加之 IaaS 中每一个任务的执行路径非常长，例如创建一个虚拟机就涉及到计算节点，网络节点，存储节点状态的变化，其中任何一个步骤都可能出错。一旦错误发生，由于当前 IaaS 缺乏回退机制，某些子系统会遗留在中间状态。比如一个虚拟机最后创建失败了，但它的 DHCP 信息却可能遗留在网络节点，导致将来可能的 DHCP 冲突。为此，ZStack 设计了一个 workflow 引擎，将任务的每个操作都封装到 flow 中，一旦某个操作出错，workflow 引擎会回退 (rollback) 所以已经执行的 flow，保证不会系统遗留在中间状态。


[#flow_engine]
.工作流演示
image::image-2022-03-02-15-38-34-978.png[]

例如在上图 <<flow_engine>> 的创建虚拟机 workflow 中，假设任务在 VmCreateOnHypervisorFlow 这一步失败了，workflow 引擎会回退前面已执行的 6 个 flow，包括子 workflow（图中计算节点分配 workflow，创建网络节点虚拟机的 workflow）。例如删除已创建的网络节点虚拟机，删除已创建的虚拟磁盘，归还已分配的计算资源到计算节点等。最大程度保证系统状态的完整性。

除了可以回退外，workflow 引擎还可以允许开发人员通过 XML 文件来配置关键任务。例如在上图中，创建虚拟机的 workflow 包含一个创建网络节点虚拟机的子 workflow（Creating Appliance VM sub-workflow）。

这个子 workflow 跟创建用户虚拟机的 workflow 类似，只有分配网卡这个 flow 不同。ZStack 通过配置 XML 文件替换掉该条 flow（图中绿色部分），就实现了创建网络节点虚拟机的逻辑。这种通过 XML 文件配置 workflow 的方式被大量运用，例如计算节点分配器 (host allocator)，存储分配器 (storage allocator)，IP 地址分配器 (IP allocator) 都是通过这种方式实现的。开发人员甚至不用写新代码，只需重新组合一些 flow 的顺序就可以实现新的业务逻辑。例如计算节点分配器里的一些实现，就是通过组合已有的 flow 实现的。这种方式使 ZStack 的组件复用度非常高，帮助整个架构实现了松耦合。

==== 插件引擎

除了 workflow，ZStack 在设计最初期就引入了一个类似于 Eclipse 的插件系统，所有核心功能都是以小插件的形式搭建起来的，保证无论是添加新功能还是移除旧功能，都不会修改已有代码，从而保证在快速实现新功能的同时，整体系统可以保持稳定。这个插件系统的核心是扩展点 (extension point)。每个组件都可以定义自己的扩展点允许其它组件接入，从而扩展业务逻辑。

.插件引擎
image::image-2022-03-02-15-39-40-434.png[]

例如上图所示的安全组 (security group) 功能，它需要在虚拟机的不同生命期对防火墙规则进行编程。但对于虚拟机本身来说，安全组只是一个附加功能，所以并不应该实现在虚拟机自身的逻辑当中。基于 ZStack 的插件系统，安全组通过虚拟机模块，网络模块等定义的扩展点插入到了虚拟机生命期，网络配置等业务逻辑中，在不修改任何已有模块的情况下，实现成一个单独的 Java JAR 文件。也就是说，安全组本身不会对现有功能造成任何影响，即使删除安全组对应的 JAR 文件，整个系统也只是失去了这个功能而已。通过插件系统，ZStack 本身架构完全实现了松耦合。

==== Tag 系统

Tag system 也是 ZStack 一个创新。虽然很多 IaaS 软件也有 tag 的概念，但大多只是帮助用户管理资源。ZStack 定义一种称为 system tag 的概念，插件可以通过定义 system tag，在不修改已有数据库表的情况下，实现为现有表添加新的字段。例如在虚拟机表中并不存在一个字段叫 hostname，ZStack 的一个插件通过定义一个 vm::hostname 的 system tag，为虚拟机表增加了这个字段，从而允许用户在创建虚拟机时指定它的 hostname。通过这种方式，插件在扩展已有功能时，无需对现有数据库表格式进行修改，从而减轻了软件升级过程中数据库迁移的负担。

Workflow 引擎，插件系统，system tag 设计的核心思想是最大程度的松耦合架构，保证已有系统在快速添加新功能的情况下也能保证整体架构稳定，避免因实现新功能而反复修改已有代码，导致产品始终没有一个稳定内核的情况。

==== 测试驱动

最后，ZStack 从诞生开始就是测试驱动的。在 ZStack 中验证功能点的唯一方法就是写测试用例。我们有三个全自动化的测试系统：Integration testing system, System testing system，以及 Model-based testing system 来保证整个项目的质量。其中 Model-based testing
system 可以随机组合 API 生成测试用例，测试出很多正常使用情况下无法触及的死角。为了能够快速重现 Model-based testing system 发现的死角，我们还开发了一个回放工具，它能读入 Model-based 测试用例产生的日志而生成一个新测试用例，通过回放失败用例来产生一个供开发人员调试的环境，避免了人工手动重试数千个 API 来重现失败用例（因为 Model-based 测试用例可能随机执行数日，产生数以千计甚至万计的 API 调用）。下面是测试系统运行过程中的一个截图：

.测试截图
image::image-2022-03-02-15-01-55-564.png[]

=== 高性能

ZStack 是目前开源软件中，唯一一款号称能够以单管理节点管理几十万物理机器，数百万虚拟机，以及响应数万并发 API 调用的软件。通过我们的软件模拟器，我们测试过管理 10 万物理机，通过 1 万到 3 万并发 API 创建百万虚拟机的情况。此外我们还进行了虚拟机创建的性能测试，数据如下表：

.模拟器下并发启动虚拟机
|===
|虚拟机数量 |总花费时间

|1
|0.51 秒

|10
|1.55 秒

|100
|11.33 秒

|1000
|103 秒

|10000
|23 分钟

|===


在测试中我们只使用了单网络节点，发现 DHCP/DNS 软件 Dnsmasq 成为了性能的瓶颈。在跟 Dnsmasq 社区沟通后，通过打补丁的 Dnsmasq，我们能将创建 10000 虚拟机的时间缩短到 11 分钟。在使用多网络节点（多租户）的环境下，我们相信这个数据还可以进一步的提高。

ZStack 的高性能受益于三个架构设计：*全异步架构，无状态服务架构，无锁架构。*

全异步架构保证一个任务从 API 调用开始，到最后在外部设备上执行的过程都是全异步的，从而任何线程都不会因等待一个操作完成而阻塞。在我们的压力测试中，单管理节点响应 10000 API 调用只用了 1000 个线程就可以完成。ZStack 的全异步架构由三部分组成：异步消息，异步函数调用，异步 HTTP 调用。其中异步消息是服务之间调用时使用的。宏观上看，ZStack 的功能划分成了多个独立的服务，服务之间通过消息通信，连 API 都是以消息的形式实现。例如有虚拟机服务，网络服务，存储服务等。在服务的内部存在许多组件，他们协作完成一个服务的功能。这些组件之间的调用使用的是传统的函数调用方式，通过回调函数 (callback) 实现异步。最后，服务与外部 agent 通信时采用的是异步 HTTP 调用。例如在创建 KVM 虚拟机时，虚拟机服务将请求提交给 KVM agent 后就返回了。KVM agent 在虚拟机创建完成后，会通过回调 HTTP 链接通知虚拟机服务。

.全异步架构
image::image-2022-03-02-15-41-05-669.png[]

无状态服务是指通过一致性哈希环 (consistent hashing ring)，服务本身可以和它所管理的具体资源分离开来，服务相互之间也无需交换所管理资源的信息。例如在多管理节点部署中会存在多个虚拟机服务，他们共同管理系统中的所有虚拟机。但每个服务自身是不需要知道哪些虚拟机是自己管理的，哪些是其它人管理的。当其它服务向虚拟机服务发送请求时，会用虚拟机的 UUID 通过一致性哈希环算出管理这个虚拟机的服务，从而保证无论请求在哪个管理节点发起，最终都会被发送到相同的服务去处理。

.一致性哈希
image::image-2022-03-02-15-20-44-417.png[]

得益于无状态服务，ZStack 的所有业务逻辑无需通过锁相互竞争资源，资源竞争完全通过队列控制。由于一致性哈希环会把针对某一个资源的操作全部转发到同一个服务，ZStack 允许每个服务在内存中创建 FIFO 队列，以请求到达的顺序响应。对于所有操作只能顺序执行的资源，例如虚拟机，服务可以创建并发度为 1 的队列，保证同一时间只有一个操作在执行。

.内存队列
image::image-2022-03-02-15-04-43-440.png[]

对于允许并发操作的资源，例如物理服务器可以允许同时执行多个操作，可以创建并发度大于 1 的队列。

.架构简单说明
image::image-2022-03-02-15-04-52-864.png[]

通过基于队列的无锁架构，ZStack 即实现了对关键资源的操作同步，又实现了对操作并发度的控制，在提高系统的吞吐性同时，又保证了系统在大吞吐量时的稳定性。例如物理服务器 (host) 资源的默认并发度是 10，在系统大负荷的情况下，ZStack 保证物理服务器最多响应 10 个请求，多的请求排队，避免了过多的请求造成资源的崩溃。当然，资源的并发度完全是可配置的，用户可以通过 API 配置例如物理服务器的并发度，根据系统的负荷调整参数。

=== 扩展性

ZStack 在设计之初就考虑到了不同的用户对云的使用模式的差异性。例如公有云提供商，服务提供商，倾向于亚马逊的模式。而传统企业用户，则更喜欢 VMWare 的企业虚拟化模式 (Enterprise Virtualization)。基于插件系统，ZStack 将每个功能实现成小插件，默认是亚马逊的 EC2 模式，也就是各种资源池化。然后在这个基础上，通过一些辅助插件，ZStack 可以在 EC2 的模式上组合出 VMWare 这种以虚拟机为中心的模式。这样不同的用户就可以根据自己的需求选择相应的模式。并且两种模式还可以互通，比如以虚拟机为中心的模式也可以使用 EC2 模式所提供的安全组（security group），弹性 IP（EIP）这样的网络服务。

除了插件系统外，ZStack 也认识到很多 IaaS 的功能可以实现成单独的服务，并且允许开发者用他们熟悉的语言来实现。这种创建单独服务的方法在 ZStack 中称为进程外插件 (out-of-process plugin)。开发者可以根据自己的喜好选用自己喜欢的语言，创建与 ZStack 管理节点进程分离的服务。如果服务本身功能单一，可以订阅 ZStack 管理节点组播到消息总线的事件 (canonical events)，例如账单系统就可以监听各种资源的创建和销毁事件，完全实现独立开发。对于功能复杂的服务，例如需要访问数据库的服务，可以通过写一个轻量级的插件安装在管理节点中，然后跟进程外服务通信。第二种方式有点类似应用程序通过在操作系统中安装驱动，来实现对内核的访问。ZStack 的 web UI 就是以这种进程外插件的方式实现的。

.扩展性
image::image-2022-03-02-15-05-21-806.png[]

基于插件系统和进程外服务，ZStack 可以在持续创新，开发出各种适应用户需求的应用场景的同时，保持架构的稳定和松耦合。

== 总结

ZStack 的整个架构并非离散的功能点的组合，而是在经过精密设计后相辅相成的。例如要实现查询 API 自动化，数据模型就必须预先定义完备；又比如要实现无锁架构，就必须要有无状态服务的基础。通过对架构的缜密思考，ZStack 有信心解决当前 IaaS 行业面临的困难，为用户提供一款优秀的开源软件。

== 更多资源



英文版 Slide： http://192.168.200.100/mirror/wei.wang/ZStack%20Architecture.pptx
